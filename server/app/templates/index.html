<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Server Stats</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #121212;
            color: white;
            /*font-size: 12px;*/
        }
        .container {
            margin-top: 30px;
        }
        table {
            margin-top: 20px;
        }.charts-container {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: #1e1e1e;
            border-radius: 8px;
        }
        .charts-container canvas {
            width: 100% !important;
            height: 300px !important;
        }
        canvas {
            background: #1e1e1e;
            padding: 10px;
            border-radius: 8px;
        }
        .selected {
            border: 2px solid #ffd54f;
            font-weight: bold;
            background-color: #333 !important;
        }
        .selected td {
                border-radius: 4px;
        }
        .offline td {
            color: red !important;
            font-weight: bold !important;
        }
        .charts-container {
            display: none; /* Скрываем графики при загрузке */
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center">Server Statistics</h1>
        <div id="chartsContainer" class="charts-container">
            <h3 id="selectedServerInfo"></h3>
            <div class="row">
                <div class="col-md-6">
                    <canvas id="cpuChart"></canvas>
                </div>
                <div class="col-md-6">
                    <canvas id="memoryChart"></canvas>
                </div>
            </div>
        </div>
        <div id="containersContainer" class="mt-4" style="display:none;">
            <h3>Контейнеры на сервере: <span id="containersServerName"></span></h3>
            <table class="table table-dark table-striped">
                <thead>
                    <tr>
                        <th>Container ID</th>
                        <th>Image</th>
                        <th>Name</th>
                        <th>Status</th>
                        <th>CPU %</th>
                        <th>Memory Usage</th>
                    </tr>
                </thead>
                
                <tbody id="containers-body"></tbody>
            </table>
        </div>

        <div id="gitlabRunnerContainer" class="mt-4" style="display:none;">
            <h3>GitLab Runner на сервере: <span id="gitlabRunnerServerName"></span></h3>
            <div id="gitlabRunnerError" class="text-warning"></div>
            <div id="gitlabRunnerData" style="display:none;">
                <div>Состояние службы: <span id="runnerServiceStatus"></span></div>
                <div>Установлен: <span id="runnerInstalled"></span></div>
                <div>Версия: <span id="runnerVersion"></span></div>
                <div>Start time: <span id="runnerStartTime"></span></div>
                <div>Job: <span id="runnerJob"></span></div>
        
                <h5 class="mt-3">Список зарегистрированных раннеров:</h5>
                <table class="table table-dark table-striped">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Executor</th>
                            <th>URL</th>
                        </tr>
                    </thead>
                    <tbody id="gitlabRunnerTableBody"></tbody>
                </table>
            </div>
        </div>
        
        
        <table class="table table-dark table-striped mt-4">
            <thead>
                <tr>
                    <th>Hostname</th>
                    <th>IP Address</th>
                    <th>OS Info</th>
                    <th>CPU Usage (%)</th>
                    <th>RAM Free/Used/Total (MB)</th>
                    <th>Disk Free/Used/Total (GB)</th>
                    <th>Last Connect (sec.)</th>
                </tr>
            </thead>
            <tbody id="stats-body"></tbody>
        </table>
    </div>

    <script>
        const cpuChartCtx = document.getElementById('cpuChart').getContext('2d');
        const memoryChartCtx = document.getElementById('memoryChart').getContext('2d');
        const chartsContainer = document.getElementById("chartsContainer");
        const containersContainer = document.getElementById("containersContainer");
        const containersServerInfo = document.getElementById("containersServerInfo");
        const containersBody = document.getElementById("containers-body");


        let cpuChart = new Chart(cpuChartCtx, {
            type: 'line',
            data: { labels: [], datasets: [{ 
                label: 'CPU Usage (%)', 
                data: [], 
                borderColor: 'red', 
                backgroundColor: 'rgba(255, 0, 0, 0.2)',
                fill: true
            }] },
            options: { responsive: true, scales: { y: { beginAtZero: true, max: 100 } } }
        });

        let memoryChart = new Chart(memoryChartCtx, {
            type: 'line',
            data: { labels: [], datasets: [{ 
                label: 'Memory Usage (MB)', 
                data: [], 
                borderColor: 'blue', 
                backgroundColor: 'rgba(0, 0, 255, 0.2)',
                fill: true
            }] },
            options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });

        let selectedAgent = null;
        let selectedHostname = null;

        function fetchStats() {
            fetch('/stats')
                .then(response => response.json())
                .then(data => {
                    const tableBody = document.getElementById("stats-body");
                    tableBody.innerHTML = "";

                    data.forEach(row => {
                        const lastSeen = Math.round(row.last_seen);
                        const isOffline = lastSeen > 180;

                        const tr = document.createElement("tr");
                        tr.innerHTML = `
                            <td>${row.hostname}</td>
                            <td>${row.ip_address}</td>
                            <td>${row.os_info}</td>
                            <td>${row.cpu_usage}</td>
                            <td>${row.memory_total - row.memory_used} / ${row.memory_used} / ${row.memory_total}</td>
                            <td>${row.disk_free} / ${row.disk_total - row.disk_free} / ${row.disk_total}</td>
                            <td>${lastSeen} sec. ago</td>
                        `;

                        tr.classList.toggle("offline", isOffline);
                        tr.style.color = isOffline ? "red" : "white";

                        tr.addEventListener("click", (event) => {
                            event.stopPropagation();
                            selectAgent(row.ip_address, row.hostname, tr);
                        });
                        
                        // Восстанавливаем выбранный элемент
                        if (row.ip_address === selectedAgent) {
                            tr.classList.add("selected");
                        }

                        tableBody.appendChild(tr);
                    });

                    // При каждом обновлении, если есть выбранный сервер, загружаем его данные
                    if (selectedAgent && selectedHostname) {
                        fetchAgentStats(selectedAgent, selectedHostname);
                    }
                })
                .catch(error => console.error('Error fetching stats:', error));
        }


        function selectAgent(ip, hostname, rowElement) {
            selectedAgent = ip;
            selectedHostname = hostname;
        
            document.querySelectorAll("tr").forEach(tr => tr.classList.remove("selected"));
            rowElement.classList.add("selected");
        
            chartsContainer.style.display = "block";
            document.getElementById("selectedServerInfo").innerHTML =
                `<b>${hostname}</b> (${ip})`;
        
            fetchAgentStats(ip, hostname);
        }       
        

        function fetchAgentStats(ip, hostname) {
            fetch(`/stats/${ip}`)
                .then(response => response.json())
                .then(data => {
                    if (data.length === 0) {
                        console.warn("Нет данных для отображения.");
                        return;
                    }
        
                    let labels = data.map(entry => new Date(parseInt(entry.last_update)).toLocaleTimeString());
                    let cpuData = data.map(entry => entry.cpu_usage);
                    let memoryData = data.map(entry => entry.memory_used);
        
                    if (labels.length > 100) {
                        labels = labels.slice(-100);
                        cpuData = cpuData.slice(-100);
                        memoryData = memoryData.slice(-100);
                    }
        
                    cpuChart.data.labels = labels;
                    cpuChart.data.datasets[0].data = cpuData;
                    cpuChart.update(); 
        
                    memoryChart.data.labels = labels;
                    memoryChart.data.datasets[0].data = memoryData;
                    memoryChart.update();
        
                    // Берём первую запись (самую новую!)
                    const latestRecord = data[0];
                    // Выводим Docker
                    displayContainers(latestContainers(data), hostname, ip);
                    // Выводим GitLab Runner
                    displayGitlabRunner(latestRecord.gitlab_runner, hostname, ip);
                })
                .catch(error => console.error('Ошибка загрузки данных:', error));
        }     

        function displayContainers(containers, hostname, ip) {
            const containersContainer = document.getElementById("containersContainer");
            const containersBody = document.getElementById("containers-body");
            const containersServerName = document.getElementById("containersServerName");
        
            containersContainer.style.display = "block";
            containersServerName.innerText = `${hostname} (${ip})`;
            containersBody.innerHTML = '';
        
            if (containers.length > 0) {
                containers.forEach(container => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${container.id}</td>
                        <td>${container.image}</td>
                        <td>${container.name}</td>
                        <td>${container.status}</td>
                        <td>${container.cpu_perc}</td>
                        <td>${container.mem_usage}</td>
                    `;
                    containersBody.appendChild(tr);
                });
            } else {
                containersBody.innerHTML = '<tr><td colspan="6">Контейнеры не найдены.</td></tr>';
            }
        }
        
        function displayGitlabRunner(gitlabRunner, hostname, ip) {
            const gitlabRunnerContainer = document.getElementById("gitlabRunnerContainer");
            const gitlabRunnerServerName = document.getElementById("gitlabRunnerServerName");
            const gitlabRunnerError = document.getElementById("gitlabRunnerError");
            const gitlabRunnerData = document.getElementById("gitlabRunnerData");
        
            const runnerServiceStatus = document.getElementById("runnerServiceStatus");
            const runnerInstalled = document.getElementById("runnerInstalled");
            const runnerVersion = document.getElementById("runnerVersion");
            const runnerStartTime = document.getElementById("runnerStartTime");
            const runnerJob = document.getElementById("runnerJob");
            const gitlabRunnerTableBody = document.getElementById("gitlabRunnerTableBody");
        
            // Сначала прячем контейнер – будем показывать его только если Runner есть
            gitlabRunnerContainer.style.display = "none";
            gitlabRunnerError.innerHTML = "";
            gitlabRunnerData.style.display = "none";
        
            // Если Runner не пришёл или состояние unknown — НЕ показываем блок, 
            // просто выводим короткую фразу (или можно ничего не показывать)
            if (!gitlabRunner || gitlabRunner.active === "unknown") {
                // Например, просто выводим где-нибудь сообщение:
                console.log("gitlab-runner отсутствует на сервере...");
                // Или можно сделать alert или вставить в отдельный div
                return;
            }
        
            // Если дошли сюда — Runner есть, показываем блок
            gitlabRunnerContainer.style.display = "block";
            gitlabRunnerData.style.display = "block";
            gitlabRunnerServerName.innerText = `${hostname} (${ip})`;
        
            runnerServiceStatus.textContent = gitlabRunner.active || "unknown";
            runnerInstalled.textContent = gitlabRunner.installed ? "Да" : "Нет";
            runnerVersion.textContent = gitlabRunner.version || "-";
            runnerStartTime.textContent = gitlabRunner.start_time || "-";
            runnerJob.textContent = gitlabRunner.job || "-";
        
            // Заполняем таблицу раннеров
            gitlabRunnerTableBody.innerHTML = "";
            const runners = gitlabRunner.runners || [];
            if (runners.length > 0) {
                runners.forEach(r => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${r.name}</td>
                        <td>${r.executor}</td>
                        <td>${r.url}</td>
                    `;
                    gitlabRunnerTableBody.appendChild(tr);
                });
            } else {
                gitlabRunnerTableBody.innerHTML =
                    '<tr><td colspan="3">Нет зарегистрированных раннеров</td></tr>';
            }
        }
        

        
        function latestContainers(data) {
            for (let entry of data) {
                if (entry.containers && entry.containers.length > 0) {
                    return entry.containers;
                }
            }
            return [];
        }
        

        // Добавляем обработчик, который скрывает графики при клике вне таблицы и графиков
        document.body.addEventListener("click", () => {
            chartsContainer.style.display = "none";
            containersContainer.style.display = "none";
            selectedAgent = null;
            document.querySelectorAll("tr").forEach(tr => tr.classList.remove("selected"));
        });

        // Запрещаем сворачивание при клике внутри графиков
        chartsContainer.addEventListener("click", (event) => {
            event.stopPropagation();
        });

        fetchStats();
        setInterval(fetchStats, 2000); // Обновляем таблицу каждые 2 секунды
    </script>
</body>
</html>
